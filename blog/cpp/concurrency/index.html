<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Multithreading support was introduced in C+11 which is a feature that allows concurrent execution of two or more parts of a program for maximum utilization of the CPU."><meta name=author content="Chao Yao"><link href=https://leonhartyao.github.io/blog/cpp/concurrency/ rel=canonical><link rel=icon href=../../../assets/robot.svg><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.14"><title>Multithreading and Concurrency in C++ - Dr. -Ing. Chao Yao 『 姚超 』</title><link rel=stylesheet href=../../../assets/stylesheets/main.342714a4.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto+Sans:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Noto Sans";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script> <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent=deep-purple> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#thread class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title="Dr. -Ing. Chao Yao 『 姚超 』" class="md-header__button md-logo" aria-label="Dr. -Ing. Chao Yao 『 姚超 』" data-md-component=logo> <img src=../../../assets/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Dr. -Ing. Chao Yao 『 姚超 』 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Multithreading and Concurrency in C++ </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent=deep-purple aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=deep-purple data-md-color-accent=deep-purple aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/chaolmu/mkdocs_pages title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> source code </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="Dr. -Ing. Chao Yao 『 姚超 』" class="md-nav__button md-logo" aria-label="Dr. -Ing. Chao Yao 『 姚超 』" data-md-component=logo> <img src=../../../assets/logo.png alt=logo> </a> Dr. -Ing. Chao Yao 『 姚超 』 </label> <div class=md-nav__source> <a href=https://github.com/chaolmu/mkdocs_pages title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> source code </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../../../about/ class=md-nav__link> <span class=md-ellipsis> About me </span> </a> </li> <li class=md-nav__item> <a href=../../ class=md-nav__link> <span class=md-ellipsis> Blogs </span> </a> </li> <li class=md-nav__item> <a href=../../../til/ class=md-nav__link> <span class=md-ellipsis> TIL </span> </a> </li> <li class=md-nav__item> <a href=../../../tag/ class=md-nav__link> <span class=md-ellipsis> Tags </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <div class="md-nav__link md-nav__container"> <a href=../../../projects/ class="md-nav__link "> <span class=md-ellipsis> Projects </span> </a> <label class="md-nav__link " for=__nav_6 id=__nav_6_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Projects </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../projects/flypulator/ class=md-nav__link> <span class=md-ellipsis> FLYPULATOR </span> </a> </li> <li class=md-nav__item> <a href=../../../projects/t-rox/ class=md-nav__link> <span class=md-ellipsis> T-RoX </span> </a> </li> <li class=md-nav__item> <a href=../../../projects/irpn/ class=md-nav__link> <span class=md-ellipsis> IRPN </span> </a> </li> <li class=md-nav__item> <a href=../../../projects/klpa/ class=md-nav__link> <span class=md-ellipsis> SLPD </span> </a> </li> <li class=md-nav__item> <a href=../../../projects/freescale/ class=md-nav__link> <span class=md-ellipsis> NUSICR </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#thread class=md-nav__link> <span class=md-ellipsis> Thread </span> </a> <nav class=md-nav aria-label=Thread> <ul class=md-nav__list> <li class=md-nav__item> <a href=#launching-thread class=md-nav__link> <span class=md-ellipsis> Launching Thread </span> </a> </li> <li class=md-nav__item> <a href=#join-and-detach class=md-nav__link> <span class=md-ellipsis> Join and Detach </span> </a> </li> <li class=md-nav__item> <a href=#manage-the-current-thread class=md-nav__link> <span class=md-ellipsis> Manage the Current Thread </span> </a> </li> <li class=md-nav__item> <a href=#call_once class=md-nav__link> <span class=md-ellipsis> Call_once </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#critical-section-and-race-condition class=md-nav__link> <span class=md-ellipsis> Critical Section and Race Condition </span> </a> </li> <li class=md-nav__item> <a href=#mutex-and-lock class=md-nav__link> <span class=md-ellipsis> Mutex and Lock </span> </a> <nav class=md-nav aria-label="Mutex and Lock"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#mutual-exclusion class=md-nav__link> <span class=md-ellipsis> Mutual Exclusion </span> </a> </li> <li class=md-nav__item> <a href=#raii-wrappers class=md-nav__link> <span class=md-ellipsis> RAII Wrappers </span> </a> <nav class=md-nav aria-label="RAII Wrappers"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#unique_lock class=md-nav__link> <span class=md-ellipsis> Unique_lock </span> </a> </li> <li class=md-nav__item> <a href=#shared_lock class=md-nav__link> <span class=md-ellipsis> Shared_lock </span> </a> </li> <li class=md-nav__item> <a href=#scoped_lock class=md-nav__link> <span class=md-ellipsis> Scoped_lock </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#deadlocks class=md-nav__link> <span class=md-ellipsis> Deadlocks </span> </a> </li> <li class=md-nav__item> <a href=#condition-variables class=md-nav__link> <span class=md-ellipsis> Condition Variables </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#future class=md-nav__link> <span class=md-ellipsis> Future </span> </a> <nav class=md-nav aria-label=Future> <ul class=md-nav__list> <li class=md-nav__item> <a href=#promise-and-future class=md-nav__link> <span class=md-ellipsis> promise and future </span> </a> <nav class=md-nav aria-label="promise and future"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#share-with-pointer class=md-nav__link> <span class=md-ellipsis> Share with Pointer </span> </a> </li> <li class=md-nav__item> <a href=#c11-promise-and-future class=md-nav__link> <span class=md-ellipsis> C++11 promise and future </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#async class=md-nav__link> <span class=md-ellipsis> async </span> </a> </li> <li class=md-nav__item> <a href=#packaged_task class=md-nav__link> <span class=md-ellipsis> packaged_task </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#parallel-stl class=md-nav__link> <span class=md-ellipsis> Parallel STL </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <nav class=md-tags> <a href=../../../tag/#tag:c class=md-tag>C++</a> </nav> <a href=https://github.com/chaolmu/mkdocs_pages/edit/master/docs/blog/cpp/concurrency.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg> </a> <h1>Multithreading and Concurrency in C++</h1> <p>Multithreading is a feature that allows concurrent execution of two or more parts of a program for maximum utilization of the CPU. Multithreading support was introduced in C+11. <a class=glightbox href=https://www.modernescpp.com/images/blog/MultithreadingCpp17Cpp20/MultithreadingInCpp17Cpp20/timelineCpp17andCpp20.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt="cpp roadmap" src=https://www.modernescpp.com/images/blog/MultithreadingCpp17Cpp20/MultithreadingInCpp17Cpp20/timelineCpp17andCpp20.png></a></p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Multiple threads may read from the same memory location while all other accesses (r-w,w-r and w-w) are called conflicts. Data races, deadlocks are undefined behavior.</p> </div> <h2 id=thread>Thread<a class=headerlink href=#thread title="Permanent link">&para;</a></h2> <h3 id=launching-thread>Launching Thread<a class=headerlink href=#launching-thread title="Permanent link">&para;</a></h3> <p>The constructor of <code>std::thread</code> can be used to start a new thread. We simply need to pass the executing code to be called (i.e, a callable object). Once the object is created a new thread is launched which will execute the code specified in callable. A callable can be either of the three</p> <ul> <li>Function pointer</li> <li>Function object</li> <li>Lambda expression</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=kt>void</span><span class=w> </span><span class=nf>foo</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>b</span><span class=p>)</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=p>{</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Thread has ID: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=p>}</span>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=k>class</span><span class=w> </span><span class=nc>bar</span>
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=p>{</span>
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=w>  </span><span class=c1>// Overload () operator</span>
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=nf>operator</span><span class=p>()(</span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=p>)</span>
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=w>      </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Thread has ID: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=p>};</span>
<a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
<a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=p>{</span>
<a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span>
<a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a><span class=w>  </span><span class=c1>// Pass a function and args</span>
<a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t1</span><span class=p>(</span><span class=n>foo</span><span class=p>,</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>);</span>
<a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a><span class=w>  </span><span class=c1>// Pass a lambda</span>
<a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t2</span><span class=p>([</span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>](){</span><span class=w> </span><span class=n>foo</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>);</span><span class=w> </span><span class=p>});</span>
<a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a><span class=w>  </span><span class=c1>// Pass a function object</span>
<a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t3</span><span class=p>(</span><span class=n>bar</span><span class=p>(),</span><span class=w> </span><span class=n>a</span><span class=p>);</span>
<a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a><span class=w>  </span><span class=c1>// Execute in the main thread</span>
<a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a><span class=w>  </span><span class=n>foo</span><span class=p>(</span><span class=mi>6</span><span class=p>,</span><span class=w> </span><span class=mi>7</span><span class=p>);</span>
<a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a><span class=w>  </span><span class=n>t3</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
<a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a><span class=w>  </span><span class=n>t2</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
<a id=__codelineno-0-29 name=__codelineno-0-29 href=#__codelineno-0-29></a><span class=w>  </span><span class=n>t1</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
<a id=__codelineno-0-30 name=__codelineno-0-30 href=#__codelineno-0-30></a><span class=p>}</span>
</code></pre></div> <p>Thread is movable but not copyable. <code>std::move</code> tansfers all resources associated with the running thread. The <em>move-from</em> thread becomes empty and not joinable, and only the <em>move-to</em> thread can be joined.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;string_view&gt;</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=kt>void</span><span class=w> </span><span class=nf>foo</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string_view</span><span class=w> </span><span class=n>s</span><span class=p>);</span>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=p>{</span>
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t1</span><span class=p>([]()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>foo</span><span class=p>(</span><span class=s>&quot;Hi</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>);</span><span class=w> </span><span class=p>});</span>
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>t1</span><span class=p>);</span><span class=w> </span><span class=c1>// t1 is now empty</span>
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=w>  </span><span class=n>t2</span><span class=p>.</span><span class=n>join</span><span class=p>();</span><span class=w> </span><span class=c1>// OK, thread originally started in t1 is joined</span>
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=p>}</span>
</code></pre></div> <p>Thread can be used in standard library containers, e.g.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=kt>void</span><span class=w> </span><span class=nf>foo</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>);</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=p>{</span>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>threadPool</span><span class=p>;</span>
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>9</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span>
<a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=w>    </span><span class=n>threadPool</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>([</span><span class=n>i</span><span class=p>]()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>foo</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w> </span><span class=p>});</span>
<a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=w>  </span><span class=c1>// Digits 1 to 9 are printed (unordered)</span>
<a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=o>&amp;</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>threadPool</span><span class=p>)</span>
<a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
<a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=p>}</span>
</code></pre></div> <h3 id=join-and-detach>Join and Detach<a class=headerlink href=#join-and-detach title="Permanent link">&para;</a></h3> <p>The thread will terminate once the function returns. The member function <code>join()</code> can be used to wait for a thread to finish. This function makes the current thread wait until the thread identified by <code>*this</code> has finished executing. It must be called exactly once for each thread.</p> <p>Alternatively, a thread can be detached for the thread object with <code>detach()</code>. The thread object can be destroyed and the OS thread of execution can continue on. If the program needs to know when that thread of execution has completed, some other mechanism needs to be used. <code>join()</code> cannot be called on that thread object any more, since it is no longer associated with a thread of execution.</p> <p><code>join()</code> or <code>detach()</code> must be called <strong>before</strong> a thread object is destroyed. It is considered an error to destroy a C++ thread object while it is still "joinable". If a C++ thread object is still joinable when it's destroyed, an exception will be thrown.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;string_view&gt;</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=kt>void</span><span class=w> </span><span class=nf>foo</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string_view</span><span class=w> </span><span class=n>s</span><span class=p>);</span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=p>{</span>
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t1</span><span class=p>([]()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>foo</span><span class=p>(</span><span class=s>&quot;Hi</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>);</span><span class=w> </span><span class=p>});</span>
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=w>  </span><span class=n>t1</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=p>}</span>
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=c1>// Everything is fine, we called t1.join()</span>
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=p>{</span>
<a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t2</span><span class=p>([]()</span><span class=w> </span><span class=p>{});</span>
<a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=p>}</span>
<a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=c1>// Program terminated because t2 is joinable when destroyed</span>
<a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=p>}</span>
</code></pre></div> <p>Both API can be called only on a joinable thread. It can be checked with <code>joinable()</code> before calling <code>joint()</code> or <code>detach()</code>.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=nf>th</span><span class=p>(</span><span class=n>foo</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>);</span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>th</span><span class=p>.</span><span class=n>joinable</span><span class=p>())</span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=p>{</span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=w>  </span><span class=n>th</span><span class=p>.</span><span class=n>detach</span><span class=p>();</span>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=p>}</span>
</code></pre></div> <h3 id=manage-the-current-thread>Manage the Current Thread<a class=headerlink href=#manage-the-current-thread title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>API</th> <th>C++ Version</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td>yield</td> <td>C++11</td> <td>suggests that the implementation reschedule execution of threads</td> </tr> <tr> <td>get_id</td> <td>C++11</td> <td>returns the thread id of the current thread (OS specific)</td> </tr> <tr> <td>sleep_for</td> <td>C++11</td> <td>blocks the execution of the current thread for at least the specified sleep_duration.</td> </tr> <tr> <td>sleep_until</td> <td>C++11</td> <td>blocks the execution of the current thread until specified sleep_time has been reached.</td> </tr> </tbody> </table> <p>Each thread object has an associated ID <code>std::thread::id</code> which can be get by <code>std::thread::get_id()</code>. <code>std::this_thread::get_id()</code> returns the ID of the current thread. If a thread object has no associated thread, <code>get_id()</code> will return "not any thread"</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>In the example, the arguments are passed by value. If you pass by reference, the life time of the variable has to be considered. The thread kann exceed its lifetime, which leads to access a destroyed object.</p> </div> <h3 id=call_once>Call_once<a class=headerlink href=#call_once title="Permanent link">&para;</a></h3> <p>In some use cases, we want to executes the Callable object exactly once, even if called concurrently, from several threads. For instance, you have to do a <em>not-thread-safe</em> one-time global initialization before you're able to do some <em>thread-safe</em> stuff. You can use <code>call_once</code> that calls the initialization only once, no matter in which thread and whether it's called concurrently.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>()</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=p>{</span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Initializing...&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=w>  </span><span class=c1>// Do something</span>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=p>}</span>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=kt>void</span><span class=w> </span><span class=nf>worker</span><span class=p>(</span><span class=n>once_flag</span><span class=o>*</span><span class=w> </span><span class=n>flag</span><span class=p>)</span>
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=p>{</span>
<a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=w>  </span><span class=n>call_once</span><span class=p>(</span><span class=o>*</span><span class=n>flag</span><span class=p>,</span><span class=w> </span><span class=n>init</span><span class=p>);</span>
<a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=p>}</span>
<a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a>
<a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
<a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=p>{</span>
<a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a><span class=w>  </span><span class=n>once_flag</span><span class=w> </span><span class=n>flag</span><span class=p>;</span>
<a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>threadPool</span><span class=p>;</span>
<a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>9</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span>
<a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a><span class=w>    </span><span class=n>threadPool</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=p>(</span><span class=n>worker</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>flag</span><span class=p>));</span>
<a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=o>&amp;</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>threadPool</span><span class=p>)</span>
<a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
<a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a><span class=p>}</span>
</code></pre></div> <p>In this example, all 9 threads will call <code>init</code> once. We don't know which thread has called the init function but it doesn't matter.</p> <h2 id=critical-section-and-race-condition>Critical Section and Race Condition<a class=headerlink href=#critical-section-and-race-condition title="Permanent link">&para;</a></h2> <p>A <strong>critical section</strong> is a section of code that is executed by multiple threads and where the sequence of execution for the threads makes a difference in the result of the concurrent execution of the critical section.</p> <p>A <strong>race condition</strong> is a situation that may occur inside a critical section. This happens when the result of multiple thread execution in critical section differs according to the order in which the threads execute. The term race condition stems from the metaphor that the threads are racing through the critical section, and that the result of that race impacts the result of executing the critical section. Race conditions can be extremely difficult to debug simply because the bug itself depends on the timing of nondeterministic events. It is quite common that the bug cannot be recreated by testers, particularly if the problematic timing results from a rare circumstance.</p> <div class="admonition danger"> <p class=admonition-title>Story</p> <p>The Therac-25 radiation therapy machine is a classic and well-cited example of a race condition with deadly effects. The software for this machine included a one-byte counter. If the machine’s operator entered terminal input to the machine at the exact moment that the counter overflowed (quite common for a counter with only 256 possible values), a critical safety lock failed. This flaw made it possible for patients to receive approximately 100 times the intended radiation dose, which directly caused the deaths of three patients. <sup id=fnref:1><a class=footnote-ref href=#fn:1>1</a></sup></p> </div> <p>Let's try the following example. Five threads are launched to add 1000 respectively to a shared account object. The initial amount is 0 and the expected amount is 5000 when all the threads are finished.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=k>class</span><span class=w> </span><span class=nc>Account</span>
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=p>{</span>
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=k>public</span><span class=o>:</span>
<a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=w>  </span><span class=n>Account</span><span class=p>()</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>mMoney</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{}</span>
<a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=n>getMoney</span><span class=p>()</span>
<a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>mMoney</span><span class=p>;</span>
<a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=n>addMoney</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>money</span><span class=p>)</span>
<a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>money</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=w>      </span><span class=n>mMoney</span><span class=o>++</span><span class=p>;</span>
<a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a>
<a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a><span class=k>private</span><span class=o>:</span>
<a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=n>mMoney</span><span class=p>;</span>
<a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a><span class=p>};</span>
<a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a>
<a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a><span class=kt>int</span><span class=w> </span><span class=nf>testMultiThreadAccount</span><span class=p>()</span>
<a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a><span class=p>{</span>
<a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a><span class=w>  </span><span class=n>Account</span><span class=w> </span><span class=n>myAccountObj</span><span class=p>;</span>
<a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>threadpool</span><span class=p>;</span>
<a id=__codelineno-6-28 name=__codelineno-6-28 href=#__codelineno-6-28></a><span class=w>  </span><span class=c1>// 5 thread to add 1000 to myAccountobj in each.</span>
<a id=__codelineno-6-29 name=__codelineno-6-29 href=#__codelineno-6-29></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>5</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-30 name=__codelineno-6-30 href=#__codelineno-6-30></a><span class=w>    </span><span class=n>threadpool</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>Account</span><span class=o>::</span><span class=n>addMoney</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>myAccountObj</span><span class=p>,</span><span class=w> </span><span class=mi>1000</span><span class=p>));</span>
<a id=__codelineno-6-31 name=__codelineno-6-31 href=#__codelineno-6-31></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-6-32 name=__codelineno-6-32 href=#__codelineno-6-32></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=o>&amp;</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>threadpool</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-33 name=__codelineno-6-33 href=#__codelineno-6-33></a><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
<a id=__codelineno-6-34 name=__codelineno-6-34 href=#__codelineno-6-34></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-6-35 name=__codelineno-6-35 href=#__codelineno-6-35></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>myAccountObj</span><span class=p>.</span><span class=n>getMoney</span><span class=p>();</span>
<a id=__codelineno-6-36 name=__codelineno-6-36 href=#__codelineno-6-36></a><span class=p>}</span>
<a id=__codelineno-6-37 name=__codelineno-6-37 href=#__codelineno-6-37></a>
<a id=__codelineno-6-38 name=__codelineno-6-38 href=#__codelineno-6-38></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
<a id=__codelineno-6-39 name=__codelineno-6-39 href=#__codelineno-6-39></a><span class=p>{</span>
<a id=__codelineno-6-40 name=__codelineno-6-40 href=#__codelineno-6-40></a><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=p>;</span>
<a id=__codelineno-6-41 name=__codelineno-6-41 href=#__codelineno-6-41></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>1000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-42 name=__codelineno-6-42 href=#__codelineno-6-42></a><span class=w>    </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>testMultiThreadAccount</span><span class=p>();</span>
<a id=__codelineno-6-43 name=__codelineno-6-43 href=#__codelineno-6-43></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>5000</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-44 name=__codelineno-6-44 href=#__codelineno-6-44></a><span class=w>      </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Error at run = &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;, Money in accout = &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-6-45 name=__codelineno-6-45 href=#__codelineno-6-45></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-6-46 name=__codelineno-6-46 href=#__codelineno-6-46></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-6-47 name=__codelineno-6-47 href=#__codelineno-6-47></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-6-48 name=__codelineno-6-48 href=#__codelineno-6-48></a><span class=p>}</span>
</code></pre></div> <p>The result is sometimes less than the expectation due to race condition.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>Error at run = 302, Money in accout = 4651
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>Error at run = 540, Money in accout = 4985
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>Error at run = 625, Money in accout = 4000
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>Error at run = 662, Money in accout = 4000
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>Error at run = 809, Money in accout = 4379
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>Error at run = 816, Money in accout = 4993
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>Error at run = 821, Money in accout = 4879
<a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>Error at run = 837, Money in accout = 2000
<a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>Error at run = 875, Money in accout = 4823
<a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>Error at run = 881, Money in accout = 4701
<a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a>Error at run = 911, Money in accout = 4118
<a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a>Error at run = 949, Money in accout = 4000
</code></pre></div> <p>As we know, for modern processors, in order to speed up processing, each processor has multi-level Cache as shown in the following figure. The cache is involved when the processor is performing calculations, such as reading and writing data. It is possible that there is an inconsistency between the cache and the main memory of the system. That is, a result is computed and saved in the processor's cache, but not yet synchronized to the main memory, and this value is not visible to other processors.</p> <p><a class=glightbox href=../../../assets/images/cpu_cache.svg data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt="cpu cache" src=../../../assets/images/cpu_cache.svg></a></p> <!-- <p align="center" width="100%">
    <a class="glightbox" href="../../assets/images/cpu_cache.svg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img width="50%" src="../../assets/images/cpu_cache.svg"></a>
</p> --> <p>Actually, the statement <code>mMoney++</code> is not atomic. It is actually a combination of many instructions to accomplish. Let's say that on a particular device, this statement is accomplished by 3 machine commands and their timing may be as follows:</p> <p><a class=glightbox href=../../../assets/images/race_timing.svg data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt="race timing" src=../../../assets/images/race_timing.svg></a></p> <!-- <p align="center" width="100%">
    <a class="glightbox" href="../../assets/images/race_timing.svg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img width="50%" src="../../assets/images/race_timing.svg"></a>
</p> --> <p>In this case, an increment will be ignored, because instead of increasing the mMoney variable twice, a different register is added and the value of the "mMoney" variable is overwritten.</p> <p>Naturally, we can now understand that the race condition occurs because these threads are accessing the shared data at the same time, and the changes made by some of them are not made known to the other threads, causing the other threads to process on the wrong basis, and the result is naturally wrong. Avoiding race conditions requires data protection for critical sections. If we let only one thread access the shared data at a time, and let other threads access it afterwards, the problem can be solved.</p> <h2 id=mutex-and-lock>Mutex and Lock<a class=headerlink href=#mutex-and-lock title="Permanent link">&para;</a></h2> <h3 id=mutual-exclusion>Mutual Exclusion<a class=headerlink href=#mutual-exclusion title="Permanent link">&para;</a></h3> <p>Mutual exclusion is a straightforward way to synchronize multiple threads, thus, avoid race conditions.</p> <ul> <li>Threads acquire a lock on a mutex object before entering a critical section.</li> <li>Threads release their lock on the mutex when leaving a critical section.</li> </ul> <p>In the c++, mutexes are in the <code>&lt;mutex&gt;</code> header file, and there are mainly 6 classes:</p> <table> <thead> <tr> <th>API</th> <th>C++ version</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td>mutex</td> <td>C++11</td> <td>basic mutual exclusion</td> </tr> <tr> <td>timed_mutex</td> <td>C++11</td> <td>with timeout</td> </tr> <tr> <td>recursive_mutex</td> <td>C++11</td> <td>can be recursively locked by the same thread</td> </tr> <tr> <td>recursive_timed_mutex</td> <td>C++11</td> <td>recursive mutex with timeout</td> </tr> <tr> <td>shared_timed_mutex</td> <td>C++14</td> <td>shared mutex with timeout</td> </tr> <tr> <td>shared_mutex</td> <td>C++17</td> <td>several threads can share ownership of the same mutex</td> </tr> </tbody> </table> <p>All mutex classes have three basic member functions:</p> <p>|lock|locks the mutex, blocks if the mutex is not available| |try_lock|tries to lock the mutex, returns if the mutex is not available| |unlock|unlocks the mutex|</p> <p>Other classes are extended with following features:</p> <ul> <li><strong>timeout</strong> provides <code>try_lock_for</code> and <code>try_lock_until</code> methods. If the lock is not acquired within the time limit, it will return directly and will not wait any longer.</li> <li><strong>recursive</strong> The same lock can be locked multiple times in the same thread. This avoids some unnecessary deadlocks.</li> <li><strong>share</strong> has two levels of access. <code>shared</code>: several threads can share ownership of the same mutex. <code>exclusive</code>: only one thread can own the mutex.</li> <li>If one thread has acquired the exclusive lock (through <code>lock</code>, <code>try_lock</code>), no other threads can acquire the lock (including the shared).</li> <li>If one thread has acquired the shared lock (through <code>lock_shared</code>, <code>try_lock_shared</code>), no other thread can acquire the exclusive lock, but can acquire the shared lock.</li> </ul> <p>In practice, high-level programming model is designed like this:</p> <ul> <li>The resource (usually a class) that requires protection from data races owns a mutex object of the appropriate type.</li> <li>Threads that intend to access the resource acquire a suitable lock on the mutex <strong>before</strong> performing the actual access.</li> <li>Threads release their lock on the mutex <strong>after</strong> completing the access.</li> <li>Usually locks are simply acquired and released in the member functions of the class.</li> </ul> <p>Next, let's fix the example code with mutex. We have only to modify the <code>Account</code> class and lock in the shared function <code>addMoney</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=k>class</span><span class=w> </span><span class=nc>Account</span>
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=p>{</span>
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=k>public</span><span class=o>:</span>
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=w>  </span><span class=n>Account</span><span class=p>()</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>mMoney</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{}</span>
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=n>getMoney</span><span class=p>()</span>
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>mMoney</span><span class=p>;</span>
<a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=n>addMoney</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>money</span><span class=p>)</span>
<a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=w>    </span><span class=n>exclusive</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
<a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>money</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=w>      </span><span class=n>mMoney</span><span class=o>++</span><span class=p>;</span>
<a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a><span class=w>    </span><span class=n>exclusive</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
<a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a>
<a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a><span class=k>private</span><span class=o>:</span>
<a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=n>mMoney</span><span class=p>;</span>
<a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>exclusive</span><span class=p>;</span>
<a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a><span class=p>};</span>
</code></pre></div> <p>In the example, we have manually locked and unlocked the mutex. This is not an easy task in a complicated nested structure considering exception. What happens if we forget to release the lock at the end of the function? In this case, one thread will exit without releasing the lock and the other threads will remain waiting. To avoid this, we should use <code>std::lock_guard</code>.</p> <p>The class lock_guard is a mutex wrapper that provides a convenient RAII-style mechanism for owning a mutex for the duration of a scoped block. When a lock_guard object is created, it attempts to take ownership of the mutex it is given. When control leaves the scope in which the lock_guard object was created, the lock_guard is destructed and the mutex is released.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=k>class</span><span class=w> </span><span class=nc>Account</span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=p>{</span>
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=k>public</span><span class=o>:</span>
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=w>  </span><span class=n>Account</span><span class=p>()</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>mMoney</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{}</span>
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=n>getMoney</span><span class=p>()</span>
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>mMoney</span><span class=p>;</span>
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=n>addMoney</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>money</span><span class=p>)</span>
<a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>lock_guard</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lockGuard</span><span class=p>(</span><span class=n>exclusive</span><span class=p>);</span>
<a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>money</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=w>      </span><span class=c1>// In case of exception, destructor of lock_guard will be called</span>
<a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=w>      </span><span class=n>mMoney</span><span class=o>++</span><span class=p>;</span>
<a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a><span class=w>    </span><span class=c1>// destructor of lock_guard will be called to unlock mutex</span>
<a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a>
<a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a><span class=k>private</span><span class=o>:</span>
<a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=n>mMoney</span><span class=p>;</span>
<a id=__codelineno-9-21 name=__codelineno-9-21 href=#__codelineno-9-21></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>exclusive</span><span class=p>;</span>
<a id=__codelineno-9-22 name=__codelineno-9-22 href=#__codelineno-9-22></a><span class=p>};</span>
</code></pre></div> <p>If you compared the example using 5 threads with a serial version, it performs much worse than the single thread program.</p> <div class="admonition note"> <p class=admonition-title>WHY?</p> <p>It is costly to add and unlock locks. The most time-consuming part of the computation here is inside the lock, which can only be executed by one thread at a time serially, compared to the single-threaded model, the example is not only serial, but also increases the burden of lock, and thus slower.</p> </div> <p>The data we divide to each thread is actually independent and time consuming for data processing, but in fact this part of the logic can be handled separately by each thread and there is no need to add locks. Only one lock at the end when aggregating the data will be sufficient. To improve the performance, we modify the member function as</p> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=kt>void</span><span class=w> </span><span class=nf>addMoney</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>money</span><span class=p>)</span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=p>{</span>
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=n>tmp</span><span class=w> </span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>money</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=w>    </span><span class=n>tmp</span><span class=o>++</span><span class=p>;</span>
<a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>lock_guard</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lockGuard</span><span class=p>(</span><span class=n>exclusive</span><span class=p>);</span>
<a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=w>  </span><span class=n>mMoney</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>tmp</span><span class=p>;</span>
<a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a><span class=p>}</span>
</code></pre></div> <p>The for-loop is parallalized and the example outperforms the single thread version. We describe the scope of a lock in terms of its granularity. Fine-grained means that the lock protects a small range, and coarse-grained means that the lock protects a large range. For performance reasons, we should ensure that the lock is as fine-grained as possible. Also, time-consuming operations, such as IO, should not be performed within the scope of the lock, and if the computation is time-consuming, it should be moved outside the lock as much as possible.</p> <div class="admonition quote"> <p class=admonition-title>Quote</p> <p>In general, a lock should be held for only the minimum possible time needed to perform the required operations. –《C++ Concurrency in Action》</p> </div> <h3 id=raii-wrappers>RAII Wrappers<a class=headerlink href=#raii-wrappers title="Permanent link">&para;</a></h3> <p>Besides <code>lock_guard</code>, the standard library provides RAII wrappers for locking and unlocking mutexes</p> <table> <thead> <tr> <th>API</th> <th>C++ version</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td>lock_guard</td> <td>C++11</td> <td>implements a strictly scope-based mutex ownership wrapper</td> </tr> <tr> <td>unique_lock</td> <td>C++11</td> <td>implements movable mutex ownership wrapper</td> </tr> <tr> <td>shared_lock</td> <td>C++11</td> <td>implements movable shared mutex ownership wrapper</td> </tr> <tr> <td>scoped_lock</td> <td>C++11</td> <td>deadlock-avoiding RAII wrapper for multiple mutexes</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>The RAII wrappers should always be preferred for locking and unlocking mutexes, since it makes bugs due to inconsistent locking/unlocking much more unlikely.</p> </div> <p>The full name of RAII is <em>Resource Acquisition Is Initialization</em>. RAII is a C++ programming technique that ties the life cycle of resources that must be requested before they can be used (e.g., allocated heap memory, threads of execution, open sockets, open files, locked mutexes, disk space, database connections, etc.) to the life cycle of an object. RAII ensures that resources are available to any function that will access the object. It also ensures that all resources are released in reverse order of acquisition at the end of the lifetime of the object they control. Similarly, if the resource acquisition fails (the constructor exits with an exception), all resources acquired for the constructed object and base class subobjects are released in reverse order of initialization. This effectively eliminate memory leaks and ensure exception safety.</p> <!-- !!! summary "RAII"
    - Wrapping each resource into a class
      - where the constructor requests the resource and establishes all class invariants or throws an exception if it fails to complete, and the destructor releases the resource and never throws an exception.
      - The destructor releases resources and never throws an exception.
    - Always use a resource via an instance of the RAII class that
      - has its own automatic storage period or temporary lifetime, or
      - has a lifetime bound to the lifetime of an automatic or temporary object --> <h4 id=unique_lock>Unique_lock<a class=headerlink href=#unique_lock title="Permanent link">&para;</a></h4> <p><code>std::unique_lock</code> provides additional constructors</p> <ul> <li>unique_lock(mutex_type&amp; m, std::defer_lock_t t) – Do not immediately lock the mutex</li> <li>unique_lock(mutex_type&amp; m, std::try_to_lock_t t) – Do not block when the mutex cannot be locked</li> </ul> <p>std::unique_lock provides additional member functions</p> <ul> <li>lock() – Manually lock the mutex</li> <li>try_lock() – Try to lock the mutex, return true if successful</li> <li>operator bool() – Check if the std::unique_lock holds a lock on the mutex</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;mutex&gt;</span>
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>mutex</span><span class=p>;</span>
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=kt>void</span><span class=w> </span><span class=nf>foo</span><span class=p>()</span>
<a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=p>{</span>
<a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>mutex</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>try_to_lock</span><span class=p>);</span>
<a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>lock</span><span class=p>)</span>
<a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=w>    </span><span class=c1>// do unsynchronized work here</span>
<a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a>
<a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span><span class=w> </span><span class=c1>// block until we can get the lock</span>
<a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a>
<a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=w>  </span><span class=c1>// do synchronized work here;</span>
<a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a>
<a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a><span class=w>  </span><span class=n>lock</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span><span class=w> </span><span class=c1>// release the lock early</span>
<a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a>
<a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a><span class=w>  </span><span class=c1>// do unsynchronized work here</span>
<a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a><span class=p>}</span>
</code></pre></div> <p>The difference between <code>lock_guard</code> and <code>unique_lock</code> is that you can lock and unlock a <code>std::unique_lock</code>. <code>std::lock_guard</code> will be locked only once on construction and unlocked on destruction. <code>unique_lock</code> also provides the feature e.g., be constructed without locking the mutex immediately. <code>lock_guard</code> cannot lock multiple mutexes safely.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Since C++17, one should use <code>std::scoped_lock</code> instead of <code>std::lock_guard</code>.</p> </div> <h4 id=shared_lock>Shared_lock<a class=headerlink href=#shared_lock title="Permanent link">&para;</a></h4> <p>std::shared_lock can be used to lock a mutex in shared mode</p> <ul> <li>Constructors and member functions analogous to std::unique_lock</li> <li>Multiple threads can acquire a shared lock on the same mutex</li> <li>Shared locking attempts block if the mutex is locked in exclusive mode</li> <li>Only usable in conjunction with std::shared_mutex</li> </ul> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Shared mutexes are mostly used to implement read/write-locks. Only read accesses are allowed when holding a shared lock while write accesses are only allowed when holding an exclusive lock.</p> </div> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;shared_mutex&gt;</span>
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=k>class</span><span class=w> </span><span class=nc>SafeCounter</span>
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=p>{</span>
<a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=k>private</span><span class=o>:</span>
<a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=w>  </span><span class=k>mutable</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_mutex</span><span class=w> </span><span class=n>mutex</span><span class=p>;</span>
<a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=w>  </span><span class=kt>size_t</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=w>  </span><span class=k>public</span><span class=o>:</span>
<a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=w>  </span><span class=kt>size_t</span><span class=w> </span><span class=n>getValue</span><span class=p>()</span><span class=w> </span><span class=k>const</span>
<a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_lock</span><span class=w> </span><span class=nf>lock</span><span class=p>(</span><span class=n>mutex</span><span class=p>);</span>
<a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w> </span><span class=c1>// read access</span>
<a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a>
<a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a><span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=n>incrementValue</span><span class=p>()</span>
<a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=w> </span><span class=nf>lock</span><span class=p>(</span><span class=n>mutex</span><span class=p>);</span>
<a id=__codelineno-12-17 name=__codelineno-12-17 href=#__codelineno-12-17></a><span class=w>    </span><span class=o>++</span><span class=n>value</span><span class=p>;</span><span class=w> </span><span class=c1>// write access</span>
<a id=__codelineno-12-18 name=__codelineno-12-18 href=#__codelineno-12-18></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-12-19 name=__codelineno-12-19 href=#__codelineno-12-19></a><span class=p>};</span>
</code></pre></div> <h4 id=scoped_lock>Scoped_lock<a class=headerlink href=#scoped_lock title="Permanent link">&para;</a></h4> <p><code>Scoped_lock</code> locks a mutex for its lifetime and unlocks it when it is destroyed. Also, it can lock multiple mutexes and avoid deadlocks.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;chrono&gt;</span>
<a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;functional&gt;</span>
<a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;mutex&gt;</span>
<a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;string&gt;</span>
<a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
<a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
<a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>std</span><span class=o>::</span><span class=nn>chrono_literals</span><span class=p>;</span>
<a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a>
<a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=k>struct</span><span class=w> </span><span class=nc>Employee</span>
<a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a><span class=p>{</span>
<a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=w> </span><span class=n>lunch_partners</span><span class=p>;</span>
<a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>id</span><span class=p>;</span>
<a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>m</span><span class=p>;</span>
<a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a><span class=w>  </span><span class=n>Employee</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>id</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{}</span>
<a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>partners</span><span class=p>()</span><span class=w> </span><span class=k>const</span>
<a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;Employee &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; has lunch partners: &quot;</span><span class=p>;</span>
<a id=__codelineno-13-19 name=__codelineno-13-19 href=#__codelineno-13-19></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=o>&amp;</span><span class=w> </span><span class=n>partner</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>lunch_partners</span><span class=p>)</span>
<a id=__codelineno-13-20 name=__codelineno-13-20 href=#__codelineno-13-20></a><span class=w>      </span><span class=n>ret</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>partner</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; &quot;</span><span class=p>;</span>
<a id=__codelineno-13-21 name=__codelineno-13-21 href=#__codelineno-13-21></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ret</span><span class=p>;</span>
<a id=__codelineno-13-22 name=__codelineno-13-22 href=#__codelineno-13-22></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-13-23 name=__codelineno-13-23 href=#__codelineno-13-23></a><span class=p>};</span>
<a id=__codelineno-13-24 name=__codelineno-13-24 href=#__codelineno-13-24></a>
<a id=__codelineno-13-25 name=__codelineno-13-25 href=#__codelineno-13-25></a><span class=kt>void</span><span class=w> </span><span class=nf>send_mail</span><span class=p>(</span><span class=n>Employee</span><span class=w> </span><span class=o>&amp;</span><span class=p>,</span><span class=w> </span><span class=n>Employee</span><span class=w> </span><span class=o>&amp;</span><span class=p>)</span>
<a id=__codelineno-13-26 name=__codelineno-13-26 href=#__codelineno-13-26></a><span class=p>{</span>
<a id=__codelineno-13-27 name=__codelineno-13-27 href=#__codelineno-13-27></a><span class=w>  </span><span class=c1>// simulate a time-consuming messaging operation</span>
<a id=__codelineno-13-28 name=__codelineno-13-28 href=#__codelineno-13-28></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=mi>1</span><span class=n>s</span><span class=p>);</span>
<a id=__codelineno-13-29 name=__codelineno-13-29 href=#__codelineno-13-29></a><span class=p>}</span>
<a id=__codelineno-13-30 name=__codelineno-13-30 href=#__codelineno-13-30></a>
<a id=__codelineno-13-31 name=__codelineno-13-31 href=#__codelineno-13-31></a><span class=kt>void</span><span class=w> </span><span class=nf>assign_lunch_partner</span><span class=p>(</span><span class=n>Employee</span><span class=w> </span><span class=o>&amp;</span><span class=n>e1</span><span class=p>,</span><span class=w> </span><span class=n>Employee</span><span class=w> </span><span class=o>&amp;</span><span class=n>e2</span><span class=p>)</span>
<a id=__codelineno-13-32 name=__codelineno-13-32 href=#__codelineno-13-32></a><span class=p>{</span>
<a id=__codelineno-13-33 name=__codelineno-13-33 href=#__codelineno-13-33></a><span class=w>  </span><span class=k>static</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>io_mutex</span><span class=p>;</span>
<a id=__codelineno-13-34 name=__codelineno-13-34 href=#__codelineno-13-34></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-13-35 name=__codelineno-13-35 href=#__codelineno-13-35></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>lock_guard</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lk</span><span class=p>(</span><span class=n>io_mutex</span><span class=p>);</span>
<a id=__codelineno-13-36 name=__codelineno-13-36 href=#__codelineno-13-36></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>e1</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; and &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>e2</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; are waiting for locks&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-13-37 name=__codelineno-13-37 href=#__codelineno-13-37></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-13-38 name=__codelineno-13-38 href=#__codelineno-13-38></a>
<a id=__codelineno-13-39 name=__codelineno-13-39 href=#__codelineno-13-39></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-13-40 name=__codelineno-13-40 href=#__codelineno-13-40></a><span class=w>    </span><span class=c1>// use std::scoped_lock to acquire two locks without worrying about</span>
<a id=__codelineno-13-41 name=__codelineno-13-41 href=#__codelineno-13-41></a><span class=w>    </span><span class=c1>// other calls to assign_lunch_partner deadlocking us</span>
<a id=__codelineno-13-42 name=__codelineno-13-42 href=#__codelineno-13-42></a><span class=w>    </span><span class=c1>// and it also provides a convenient RAII-style mechanism</span>
<a id=__codelineno-13-43 name=__codelineno-13-43 href=#__codelineno-13-43></a>
<a id=__codelineno-13-44 name=__codelineno-13-44 href=#__codelineno-13-44></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>scoped_lock</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>e1</span><span class=p>.</span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=n>e2</span><span class=p>.</span><span class=n>m</span><span class=p>);</span>
<a id=__codelineno-13-45 name=__codelineno-13-45 href=#__codelineno-13-45></a>
<a id=__codelineno-13-46 name=__codelineno-13-46 href=#__codelineno-13-46></a><span class=w>    </span><span class=c1>// Equivalent code 1 (using std::lock and std::lock_guard)</span>
<a id=__codelineno-13-47 name=__codelineno-13-47 href=#__codelineno-13-47></a><span class=w>    </span><span class=c1>// std::lock(e1.m, e2.m);</span>
<a id=__codelineno-13-48 name=__codelineno-13-48 href=#__codelineno-13-48></a><span class=w>    </span><span class=c1>// std::lock_guard&lt;std::mutex&gt; lk1(e1.m, std::adopt_lock);</span>
<a id=__codelineno-13-49 name=__codelineno-13-49 href=#__codelineno-13-49></a><span class=w>    </span><span class=c1>// std::lock_guard&lt;std::mutex&gt; lk2(e2.m, std::adopt_lock);</span>
<a id=__codelineno-13-50 name=__codelineno-13-50 href=#__codelineno-13-50></a>
<a id=__codelineno-13-51 name=__codelineno-13-51 href=#__codelineno-13-51></a><span class=w>    </span><span class=c1>// Equivalent code 2 (if unique_locks are needed, e.g. for condition variables)</span>
<a id=__codelineno-13-52 name=__codelineno-13-52 href=#__codelineno-13-52></a><span class=w>    </span><span class=c1>// std::unique_lock&lt;std::mutex&gt; lk1(e1.m, std::defer_lock);</span>
<a id=__codelineno-13-53 name=__codelineno-13-53 href=#__codelineno-13-53></a><span class=w>    </span><span class=c1>// std::unique_lock&lt;std::mutex&gt; lk2(e2.m, std::defer_lock);</span>
<a id=__codelineno-13-54 name=__codelineno-13-54 href=#__codelineno-13-54></a><span class=w>    </span><span class=c1>// std::lock(lk1, lk2);</span>
<a id=__codelineno-13-55 name=__codelineno-13-55 href=#__codelineno-13-55></a><span class=w>    </span><span class=p>{</span>
<a id=__codelineno-13-56 name=__codelineno-13-56 href=#__codelineno-13-56></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>lock_guard</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lk</span><span class=p>(</span><span class=n>io_mutex</span><span class=p>);</span>
<a id=__codelineno-13-57 name=__codelineno-13-57 href=#__codelineno-13-57></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>e1</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; and &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>e2</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; got locks&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-13-58 name=__codelineno-13-58 href=#__codelineno-13-58></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-13-59 name=__codelineno-13-59 href=#__codelineno-13-59></a><span class=w>    </span><span class=n>e1</span><span class=p>.</span><span class=n>lunch_partners</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>e2</span><span class=p>.</span><span class=n>id</span><span class=p>);</span>
<a id=__codelineno-13-60 name=__codelineno-13-60 href=#__codelineno-13-60></a><span class=w>    </span><span class=n>e2</span><span class=p>.</span><span class=n>lunch_partners</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>e1</span><span class=p>.</span><span class=n>id</span><span class=p>);</span>
<a id=__codelineno-13-61 name=__codelineno-13-61 href=#__codelineno-13-61></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-13-62 name=__codelineno-13-62 href=#__codelineno-13-62></a>
<a id=__codelineno-13-63 name=__codelineno-13-63 href=#__codelineno-13-63></a><span class=w>  </span><span class=n>send_mail</span><span class=p>(</span><span class=n>e1</span><span class=p>,</span><span class=w> </span><span class=n>e2</span><span class=p>);</span>
<a id=__codelineno-13-64 name=__codelineno-13-64 href=#__codelineno-13-64></a><span class=w>  </span><span class=n>send_mail</span><span class=p>(</span><span class=n>e2</span><span class=p>,</span><span class=w> </span><span class=n>e1</span><span class=p>);</span>
<a id=__codelineno-13-65 name=__codelineno-13-65 href=#__codelineno-13-65></a><span class=p>}</span>
<a id=__codelineno-13-66 name=__codelineno-13-66 href=#__codelineno-13-66></a>
<a id=__codelineno-13-67 name=__codelineno-13-67 href=#__codelineno-13-67></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
<a id=__codelineno-13-68 name=__codelineno-13-68 href=#__codelineno-13-68></a><span class=p>{</span>
<a id=__codelineno-13-69 name=__codelineno-13-69 href=#__codelineno-13-69></a><span class=w>  </span><span class=n>Employee</span><span class=w> </span><span class=n>alice</span><span class=p>(</span><span class=s>&quot;Alice&quot;</span><span class=p>),</span><span class=w> </span><span class=n>bob</span><span class=p>(</span><span class=s>&quot;Bob&quot;</span><span class=p>),</span><span class=w> </span><span class=n>christina</span><span class=p>(</span><span class=s>&quot;Christina&quot;</span><span class=p>),</span><span class=w> </span><span class=n>dave</span><span class=p>(</span><span class=s>&quot;Dave&quot;</span><span class=p>);</span>
<a id=__codelineno-13-70 name=__codelineno-13-70 href=#__codelineno-13-70></a>
<a id=__codelineno-13-71 name=__codelineno-13-71 href=#__codelineno-13-71></a><span class=w>  </span><span class=c1>// assign in parallel threads because mailing users about lunch assignments</span>
<a id=__codelineno-13-72 name=__codelineno-13-72 href=#__codelineno-13-72></a><span class=w>  </span><span class=c1>// takes a long time</span>
<a id=__codelineno-13-73 name=__codelineno-13-73 href=#__codelineno-13-73></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>threads</span><span class=p>;</span>
<a id=__codelineno-13-74 name=__codelineno-13-74 href=#__codelineno-13-74></a><span class=w>  </span><span class=n>threads</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>assign_lunch_partner</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ref</span><span class=p>(</span><span class=n>alice</span><span class=p>),</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ref</span><span class=p>(</span><span class=n>bob</span><span class=p>));</span>
<a id=__codelineno-13-75 name=__codelineno-13-75 href=#__codelineno-13-75></a><span class=w>  </span><span class=n>threads</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>assign_lunch_partner</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ref</span><span class=p>(</span><span class=n>christina</span><span class=p>),</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ref</span><span class=p>(</span><span class=n>bob</span><span class=p>));</span>
<a id=__codelineno-13-76 name=__codelineno-13-76 href=#__codelineno-13-76></a><span class=w>  </span><span class=n>threads</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>assign_lunch_partner</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ref</span><span class=p>(</span><span class=n>christina</span><span class=p>),</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ref</span><span class=p>(</span><span class=n>alice</span><span class=p>));</span>
<a id=__codelineno-13-77 name=__codelineno-13-77 href=#__codelineno-13-77></a><span class=w>  </span><span class=n>threads</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>assign_lunch_partner</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ref</span><span class=p>(</span><span class=n>dave</span><span class=p>),</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ref</span><span class=p>(</span><span class=n>bob</span><span class=p>));</span>
<a id=__codelineno-13-78 name=__codelineno-13-78 href=#__codelineno-13-78></a>
<a id=__codelineno-13-79 name=__codelineno-13-79 href=#__codelineno-13-79></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=kr>thread</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>threads</span><span class=p>)</span>
<a id=__codelineno-13-80 name=__codelineno-13-80 href=#__codelineno-13-80></a><span class=w>      </span><span class=kr>thread</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
<a id=__codelineno-13-81 name=__codelineno-13-81 href=#__codelineno-13-81></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>alice</span><span class=p>.</span><span class=n>partners</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=w>  </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>bob</span><span class=p>.</span><span class=n>partners</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span>
<a id=__codelineno-13-82 name=__codelineno-13-82 href=#__codelineno-13-82></a><span class=w>            </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>christina</span><span class=p>.</span><span class=n>partners</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>dave</span><span class=p>.</span><span class=n>partners</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
<a id=__codelineno-13-83 name=__codelineno-13-83 href=#__codelineno-13-83></a><span class=p>}</span>
</code></pre></div> <h3 id=deadlocks>Deadlocks<a class=headerlink href=#deadlocks title="Permanent link">&para;</a></h3> <p>The following example will lead to deadlocks：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>m1</span><span class=p>,</span><span class=w> </span><span class=n>m2</span><span class=p>,</span><span class=w> </span><span class=n>m3</span><span class=p>;</span>
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=kt>void</span><span class=w> </span><span class=nf>threadA</span><span class=p>()</span>
<a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=p>{</span>
<a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=w>  </span><span class=c1>// INTENTIONALLY BUGGY</span>
<a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=w> </span><span class=n>l1</span><span class=p>{</span><span class=n>m1</span><span class=p>},</span><span class=w> </span><span class=n>l2</span><span class=p>{</span><span class=n>m2</span><span class=p>},</span><span class=w> </span><span class=n>l3</span><span class=p>{</span><span class=n>m3</span><span class=p>};</span>
<a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=p>}</span>
<a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=kt>void</span><span class=w> </span><span class=nf>threadB</span><span class=p>()</span>
<a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=p>{</span>
<a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=w>  </span><span class=c1>// INTENTIONALLY BUGGY</span>
<a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=w> </span><span class=n>l3</span><span class=p>{</span><span class=n>m3</span><span class=p>},</span><span class=w> </span><span class=n>l2</span><span class=p>{</span><span class=n>m2</span><span class=p>},</span><span class=w> </span><span class=n>l1</span><span class=p>{</span><span class=n>m1</span><span class=p>};</span>
<a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=p>}</span>
</code></pre></div> <p>Possible deadlock scenario:</p> <ul> <li>threadA() acquires locks on m1 and m2</li> <li>threadB() acquires lock on m3</li> <li>threadA() waits for threadB() to release m3</li> <li>threadB() waits for threadA() to release m2</li> </ul> <p><code>std::scoped_lock</code> RAII wrapper can be used to safely lock any number of mutexes:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>m1</span><span class=p>,</span><span class=w> </span><span class=n>m2</span><span class=p>,</span><span class=w> </span><span class=n>m3</span><span class=p>;</span>
<a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=kt>void</span><span class=w> </span><span class=nf>threadA</span><span class=p>()</span>
<a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=p>{</span>
<a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=w>  </span><span class=c1>// OK, will not deadlock</span>
<a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>scoped_lock</span><span class=w> </span><span class=n>l</span><span class=p>{</span><span class=n>m1</span><span class=p>,</span><span class=w> </span><span class=n>m2</span><span class=p>,</span><span class=w> </span><span class=n>m3</span><span class=p>};</span>
<a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=p>}</span>
<a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=kt>void</span><span class=w> </span><span class=nf>threadB</span><span class=p>()</span>
<a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a><span class=p>{</span>
<a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a><span class=w>  </span><span class=c1>// OK, will not deadlock</span>
<a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>scoped_lock</span><span class=w> </span><span class=n>l</span><span class=p>{</span><span class=n>m3</span><span class=p>,</span><span class=w> </span><span class=n>m2</span><span class=p>,</span><span class=w> </span><span class=n>m1</span><span class=p>};</span>
<a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a><span class=p>}</span>
</code></pre></div> <h3 id=condition-variables>Condition Variables<a class=headerlink href=#condition-variables title="Permanent link">&para;</a></h3> <p>A condition variable is a synchronization primitive that allows multiple threads to wait until an (arbitrary) condition becomes true.</p> <ul> <li>A condition variable uses a mutex to synchronize threads</li> <li>Threads can wait on or notify the condition variable</li> <li>When a thread waits on the condition variable, it blocks until another thread notifies it</li> <li>If a thread waited on the condition variable and is notified, it holds the mutex</li> <li>A notified thread must check the condition explicitly because spurious wake-ups can occur</li> </ul> <p>Class <code>std::condition_variable</code> in the header <code>&lt;condition_variable&gt;</code> has the following member functions:</p> <ul> <li><strong>wait()</strong>: Takes a reference to a std::unique_lock that must be locked by the caller as an argument, unlocks the mutex and waits for the condition variable</li> <li><strong>notify_one()</strong>: Notify a single waiting thread, mutex does not need to be held by the caller</li> <li><strong>notify_all()</strong>: Notify all waiting threads, mutex does not need to be held by the caller</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;string&gt;</span>
<a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
<a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;mutex&gt;</span>
<a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;condition_variable&gt;</span>
<a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a>
<a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>m</span><span class=p>;</span>
<a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=n>std</span><span class=o>::</span><span class=n>condition_variable</span><span class=w> </span><span class=n>cv</span><span class=p>;</span>
<a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>data</span><span class=p>;</span>
<a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=kt>bool</span><span class=w> </span><span class=n>ready</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
<a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=kt>bool</span><span class=w> </span><span class=n>processed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
<a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a>
<a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a><span class=kt>void</span><span class=w> </span><span class=nf>worker_thread</span><span class=p>()</span>
<a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a><span class=p>{</span>
<a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a><span class=w>    </span><span class=c1>// Wait until main() sends data</span>
<a id=__codelineno-16-16 name=__codelineno-16-16 href=#__codelineno-16-16></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=w> </span><span class=n>lk</span><span class=p>(</span><span class=n>m</span><span class=p>);</span>
<a id=__codelineno-16-17 name=__codelineno-16-17 href=#__codelineno-16-17></a><span class=w>    </span><span class=n>cv</span><span class=p>.</span><span class=n>wait</span><span class=p>(</span><span class=n>lk</span><span class=p>,</span><span class=w> </span><span class=p>[]{</span><span class=k>return</span><span class=w> </span><span class=n>ready</span><span class=p>;});</span>
<a id=__codelineno-16-18 name=__codelineno-16-18 href=#__codelineno-16-18></a>
<a id=__codelineno-16-19 name=__codelineno-16-19 href=#__codelineno-16-19></a><span class=w>    </span><span class=c1>// after the wait, we own the lock.</span>
<a id=__codelineno-16-20 name=__codelineno-16-20 href=#__codelineno-16-20></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Worker thread is processing data&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-16-21 name=__codelineno-16-21 href=#__codelineno-16-21></a><span class=w>    </span><span class=n>data</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=s>&quot; after processing&quot;</span><span class=p>;</span>
<a id=__codelineno-16-22 name=__codelineno-16-22 href=#__codelineno-16-22></a>
<a id=__codelineno-16-23 name=__codelineno-16-23 href=#__codelineno-16-23></a><span class=w>    </span><span class=c1>// Send data back to main()</span>
<a id=__codelineno-16-24 name=__codelineno-16-24 href=#__codelineno-16-24></a><span class=w>    </span><span class=n>processed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
<a id=__codelineno-16-25 name=__codelineno-16-25 href=#__codelineno-16-25></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Worker thread signals data processing completed&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-16-26 name=__codelineno-16-26 href=#__codelineno-16-26></a>
<a id=__codelineno-16-27 name=__codelineno-16-27 href=#__codelineno-16-27></a><span class=w>    </span><span class=c1>// Manual unlocking is done before notifying, to avoid waking up</span>
<a id=__codelineno-16-28 name=__codelineno-16-28 href=#__codelineno-16-28></a><span class=w>    </span><span class=c1>// the waiting thread only to block again (see notify_one for details)</span>
<a id=__codelineno-16-29 name=__codelineno-16-29 href=#__codelineno-16-29></a><span class=w>    </span><span class=n>lk</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
<a id=__codelineno-16-30 name=__codelineno-16-30 href=#__codelineno-16-30></a><span class=w>    </span><span class=n>cv</span><span class=p>.</span><span class=n>notify_one</span><span class=p>();</span>
<a id=__codelineno-16-31 name=__codelineno-16-31 href=#__codelineno-16-31></a><span class=p>}</span>
<a id=__codelineno-16-32 name=__codelineno-16-32 href=#__codelineno-16-32></a>
<a id=__codelineno-16-33 name=__codelineno-16-33 href=#__codelineno-16-33></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
<a id=__codelineno-16-34 name=__codelineno-16-34 href=#__codelineno-16-34></a><span class=p>{</span>
<a id=__codelineno-16-35 name=__codelineno-16-35 href=#__codelineno-16-35></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>worker</span><span class=p>(</span><span class=n>worker_thread</span><span class=p>);</span>
<a id=__codelineno-16-36 name=__codelineno-16-36 href=#__codelineno-16-36></a>
<a id=__codelineno-16-37 name=__codelineno-16-37 href=#__codelineno-16-37></a><span class=w>  </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;Example data&quot;</span><span class=p>;</span>
<a id=__codelineno-16-38 name=__codelineno-16-38 href=#__codelineno-16-38></a><span class=w>  </span><span class=c1>// send data to the worker thread</span>
<a id=__codelineno-16-39 name=__codelineno-16-39 href=#__codelineno-16-39></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-16-40 name=__codelineno-16-40 href=#__codelineno-16-40></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>lock_guard</span><span class=w> </span><span class=n>lk</span><span class=p>(</span><span class=n>m</span><span class=p>);</span>
<a id=__codelineno-16-41 name=__codelineno-16-41 href=#__codelineno-16-41></a><span class=w>    </span><span class=n>ready</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
<a id=__codelineno-16-42 name=__codelineno-16-42 href=#__codelineno-16-42></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;main() signals data ready for processing&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-16-43 name=__codelineno-16-43 href=#__codelineno-16-43></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-16-44 name=__codelineno-16-44 href=#__codelineno-16-44></a><span class=w>  </span><span class=n>cv</span><span class=p>.</span><span class=n>notify_one</span><span class=p>();</span>
<a id=__codelineno-16-45 name=__codelineno-16-45 href=#__codelineno-16-45></a>
<a id=__codelineno-16-46 name=__codelineno-16-46 href=#__codelineno-16-46></a><span class=w>  </span><span class=c1>// wait for the worker</span>
<a id=__codelineno-16-47 name=__codelineno-16-47 href=#__codelineno-16-47></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-16-48 name=__codelineno-16-48 href=#__codelineno-16-48></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=w> </span><span class=n>lk</span><span class=p>(</span><span class=n>m</span><span class=p>);</span>
<a id=__codelineno-16-49 name=__codelineno-16-49 href=#__codelineno-16-49></a><span class=w>    </span><span class=n>cv</span><span class=p>.</span><span class=n>wait</span><span class=p>(</span><span class=n>lk</span><span class=p>,</span><span class=w> </span><span class=p>[]{</span><span class=k>return</span><span class=w> </span><span class=n>processed</span><span class=p>;});</span>
<a id=__codelineno-16-50 name=__codelineno-16-50 href=#__codelineno-16-50></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-16-51 name=__codelineno-16-51 href=#__codelineno-16-51></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Back in main(), data = &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-16-52 name=__codelineno-16-52 href=#__codelineno-16-52></a>
<a id=__codelineno-16-53 name=__codelineno-16-53 href=#__codelineno-16-53></a><span class=w>  </span><span class=n>worker</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
<a id=__codelineno-16-54 name=__codelineno-16-54 href=#__codelineno-16-54></a><span class=p>}</span>
</code></pre></div> <p>Output:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a>main() signals data ready for processing
<a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>Worker thread is processing data
<a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a>Worker thread signals data processing completed
<a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a>Back in main(), data = Example data after processing
</code></pre></div> <h2 id=future>Future<a class=headerlink href=#future title="Permanent link">&para;</a></h2> <p>The standard library provides facilities to obtain values that are returned and to catch exceptions that are thrown by asynchronous tasks (i.e. functions launched in separate threads). These values are communicated in a shared state, in which the asynchronous task may write its return value or store an exception, and which may be examined, waited for, and otherwise manipulated by other threads that hold instances of std::future or std::shared_future that reference that shared state.</p> <table> <thead> <tr> <th>API</th> <th>C++ version</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td>async</td> <td>C++11</td> <td>Run a function asynchronously and return a std::future with its result</td> </tr> <tr> <td>future</td> <td>C++11</td> <td>waits for a value that is set asynchronously</td> </tr> <tr> <td>packaged_task</td> <td>C++11</td> <td>packages a function to store its return value for asynchronous retrieval</td> </tr> <tr> <td>promise</td> <td>C++11</td> <td>stores a value for asynchronous retrieval</td> </tr> <tr> <td>shared_future</td> <td>C++11</td> <td>similar to std::future, except that multiple threads are allowed to wait for the same shared state.</td> </tr> </tbody> </table> <h3 id=promise-and-future>promise and future<a class=headerlink href=#promise-and-future title="Permanent link">&para;</a></h3> <div class="admonition question"> <p class=admonition-title>Question</p> <p>We often encounter situations where we need to get the result returned by a thread, how we can implement it?</p> </div> <h4 id=share-with-pointer>Share with Pointer<a class=headerlink href=#share-with-pointer title="Permanent link">&para;</a></h4> <p>We can pass a pointer to a new thread in which the result will be set. The main thread will wait via condition variables. The new thread then sets the result and notifies the condition variable, the main thread will get the result from that pointer. To implement this simple feature, we use a condition variable, a mutex lock, and a pointer to capture the return value.</p> <p>If we want the thread to return multiple different values at different points in time, the problem becomes more complex. Is there an easy way to get the return value from the thread?<br> The answer is to use std::future</p> <h4 id=c11-promise-and-future>C++11 <code>promise</code> and <code>future</code><a class=headerlink href=#c11-promise-and-future title="Permanent link">&para;</a></h4> <p><code>std::future</code> is a class template whose objects store future values. In fact, a <code>std::future</code> object stores internally a value that will be assigned in the future, and provides a mechanism to access that value, implemented through the member function <code>get()</code>. But if someone tries to access the value through it before the <code>get()</code> function is available, then the it will block until that value is available. <code>std::promise</code> provides a facility to store a value or an exception that is later acquired asynchronously via a <code>std::future</code> object created by the <code>std::promise</code> object.</p> <p>Each <code>std::promise</code> object has a corresponding <code>std::future</code> object, through which others can get the value set by the <code>promise</code>. For instance,</p> <ol> <li>thread 1 creates a <code>std::promise</code> object and then get the <code>std::future</code> object from it.</li> <li>thread 1 passes it to thread 2.</li> <li>Thread 1 will get the value set by thread 2 through the <code>get()</code> of <code>std::future</code>.</li> <li>If thread 2 has not yet set the value, the <code>get()</code> call will block until thread 2 sets the value in the <code>promise</code> object.</li> </ol> <p><a class=glightbox href=../../../assets/images/promise_future.svg data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt="promise future" src=../../../assets/images/promise_future.svg></a></p> <p>Here is a complete example of <code>std::future</code> and <code>std::promise</code>.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
<a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;future&gt;</span>
<a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;chrono&gt;</span>
<a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a>
<a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=kt>void</span><span class=w> </span><span class=nf>doWork</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>promise</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>promiseObj</span><span class=p>)</span>
<a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=p>{</span>
<a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Inside new thread&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>5</span><span class=p>));</span>
<a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a><span class=w>  </span><span class=n>promiseObj</span><span class=p>.</span><span class=n>set_value</span><span class=p>(</span><span class=mi>7</span><span class=p>);</span><span class=w>  </span><span class=c1>// set value that can be accessed by future1</span>
<a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a><span class=p>}</span>
<a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a>
<a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
<a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a><span class=p>{</span>
<a id=__codelineno-18-15 name=__codelineno-18-15 href=#__codelineno-18-15></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>promise</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>promise1</span><span class=p>;</span>
<a id=__codelineno-18-16 name=__codelineno-18-16 href=#__codelineno-18-16></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>future1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>promise1</span><span class=p>.</span><span class=n>get_future</span><span class=p>();</span>
<a id=__codelineno-18-17 name=__codelineno-18-17 href=#__codelineno-18-17></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>th</span><span class=p>(</span><span class=n>doWork</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>promise1</span><span class=p>));</span>
<a id=__codelineno-18-18 name=__codelineno-18-18 href=#__codelineno-18-18></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Main thread call get() for result... &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-18-19 name=__codelineno-18-19 href=#__codelineno-18-19></a><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>future1</span><span class=p>.</span><span class=n>get</span><span class=p>();</span><span class=w>  </span><span class=c1>// blocked here until promise1 is set in the new thread</span>
<a id=__codelineno-18-20 name=__codelineno-18-20 href=#__codelineno-18-20></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Result is returned: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-18-21 name=__codelineno-18-21 href=#__codelineno-18-21></a><span class=w>  </span><span class=n>th</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
<a id=__codelineno-18-22 name=__codelineno-18-22 href=#__codelineno-18-22></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-18-23 name=__codelineno-18-23 href=#__codelineno-18-23></a><span class=p>}</span>
</code></pre></div> <h3 id=async>async<a class=headerlink href=#async title="Permanent link">&para;</a></h3> <p>The function template <code>async</code> runs a function asynchronously (potentially in a separate thread which might be a part of a thread pool) and returns a <code>std::future</code> that will eventually hold the result of that function call.</p> <p>The first parameter in <code>std::async</code> is the launch policy, which controls the asynchronous behavior.</p> <table> <thead> <tr> <th>Bit</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td>std::launch::async</td> <td>enable asynchronous evaluation (separate thread)</td> </tr> <tr> <td>std::launch::deferred</td> <td>enable lazy evaluation</td> </tr> <tr> <td>std::launch::async | std::launch::deferred</td> <td>asynchronously or not, depending on the system load (default)</td> </tr> </tbody> </table> <p>If more than one flag is set, it is implementation-defined which policy is selected. For the default (both the std::launch::async and std::launch::deferred flags are set in policy), standard recommends (but doesn't require) utilizing available concurrency, and deferring any additional tasks.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;cmath&gt;</span>
<a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
<a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;future&gt;</span>
<a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a>
<a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=k>class</span><span class=w> </span><span class=nc>Worker</span>
<a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=p>{</span>
<a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=k>public</span><span class=o>:</span>
<a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a><span class=w>  </span><span class=n>Worker</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>min</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>max</span><span class=p>)</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>mMin</span><span class=p>(</span><span class=n>min</span><span class=p>),</span><span class=w> </span><span class=n>mMax</span><span class=p>(</span><span class=n>max</span><span class=p>)</span><span class=w> </span><span class=p>{}</span><span class=w>  </span><span class=c1>// ①</span>
<a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=w>  </span><span class=kt>double</span><span class=w> </span><span class=n>work</span><span class=p>()</span>
<a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a><span class=w>  </span><span class=p>{</span><span class=w>  </span><span class=c1>//</span>
<a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a><span class=w>    </span><span class=n>mResult</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-19-13 name=__codelineno-19-13 href=#__codelineno-19-13></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mMin</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>mMax</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-19-14 name=__codelineno-19-14 href=#__codelineno-19-14></a><span class=w>      </span><span class=n>mResult</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>sqrt</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
<a id=__codelineno-19-15 name=__codelineno-19-15 href=#__codelineno-19-15></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-19-16 name=__codelineno-19-16 href=#__codelineno-19-16></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>mResult</span><span class=p>;</span>
<a id=__codelineno-19-17 name=__codelineno-19-17 href=#__codelineno-19-17></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-19-18 name=__codelineno-19-18 href=#__codelineno-19-18></a><span class=w>  </span><span class=kt>double</span><span class=w> </span><span class=n>getResult</span><span class=p>()</span>
<a id=__codelineno-19-19 name=__codelineno-19-19 href=#__codelineno-19-19></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-19-20 name=__codelineno-19-20 href=#__codelineno-19-20></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>mResult</span><span class=p>;</span>
<a id=__codelineno-19-21 name=__codelineno-19-21 href=#__codelineno-19-21></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-19-22 name=__codelineno-19-22 href=#__codelineno-19-22></a>
<a id=__codelineno-19-23 name=__codelineno-19-23 href=#__codelineno-19-23></a><span class=k>private</span><span class=o>:</span>
<a id=__codelineno-19-24 name=__codelineno-19-24 href=#__codelineno-19-24></a><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=n>mMin</span><span class=p>;</span>
<a id=__codelineno-19-25 name=__codelineno-19-25 href=#__codelineno-19-25></a><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=n>mMax</span><span class=p>;</span>
<a id=__codelineno-19-26 name=__codelineno-19-26 href=#__codelineno-19-26></a><span class=w>  </span><span class=kt>double</span><span class=w> </span><span class=n>mResult</span><span class=p>;</span>
<a id=__codelineno-19-27 name=__codelineno-19-27 href=#__codelineno-19-27></a><span class=p>};</span>
<a id=__codelineno-19-28 name=__codelineno-19-28 href=#__codelineno-19-28></a>
<a id=__codelineno-19-29 name=__codelineno-19-29 href=#__codelineno-19-29></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
<a id=__codelineno-19-30 name=__codelineno-19-30 href=#__codelineno-19-30></a><span class=p>{</span>
<a id=__codelineno-19-31 name=__codelineno-19-31 href=#__codelineno-19-31></a><span class=w>  </span><span class=n>Worker</span><span class=w> </span><span class=n>w</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mf>10e8</span><span class=p>);</span>
<a id=__codelineno-19-32 name=__codelineno-19-32 href=#__codelineno-19-32></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Task in class triggered&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-19-33 name=__codelineno-19-33 href=#__codelineno-19-33></a><span class=w>  </span><span class=k>auto</span><span class=w> </span><span class=n>f3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>async</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>launch</span><span class=o>::</span><span class=n>async</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>Worker</span><span class=o>::</span><span class=n>work</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>w</span><span class=p>);</span><span class=w>  </span><span class=c1>//</span>
<a id=__codelineno-19-34 name=__codelineno-19-34 href=#__codelineno-19-34></a><span class=w>  </span><span class=n>f3</span><span class=p>.</span><span class=n>wait</span><span class=p>();</span>
<a id=__codelineno-19-35 name=__codelineno-19-35 href=#__codelineno-19-35></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Task in class finish, result: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>w</span><span class=p>.</span><span class=n>getResult</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-19-36 name=__codelineno-19-36 href=#__codelineno-19-36></a>
<a id=__codelineno-19-37 name=__codelineno-19-37 href=#__codelineno-19-37></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-19-38 name=__codelineno-19-38 href=#__codelineno-19-38></a><span class=p>}</span>
</code></pre></div> <div class="admonition attention"> <p class=admonition-title>Attention</p> <p>Note that a pointer to the object <code>&amp;w</code> is passed. If you do not write <code>&amp;</code> a temporary copy of the object <code>w</code> will be passed in.</p> </div> <h3 id=packaged_task>packaged_task<a class=headerlink href=#packaged_task title="Permanent link">&para;</a></h3> <p>The class template <code>std::packaged_task</code> wraps any Callable target (function, lambda expression, bind expression, or another function object) so that it can be invoked asynchronously. Its return value or exception thrown is stored in a shared state which can be accessed through <code>std::future</code> objects.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;cmath&gt;</span>
<a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
<a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;future&gt;</span>
<a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;functional&gt;</span>
<a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a>
<a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a><span class=c1>// unique function to avoid disambiguating the std::pow overload set</span>
<a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a><span class=kt>int</span><span class=w> </span><span class=nf>f</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>pow</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>);</span><span class=w> </span><span class=p>}</span>
<a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a>
<a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a><span class=kt>void</span><span class=w> </span><span class=nf>task_lambda</span><span class=p>()</span>
<a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a><span class=p>{</span>
<a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>packaged_task</span><span class=o>&lt;</span><span class=kt>int</span><span class=p>(</span><span class=kt>int</span><span class=p>,</span><span class=kt>int</span><span class=p>)</span><span class=o>&gt;</span><span class=w> </span><span class=n>task</span><span class=p>([](</span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>b</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-20-13 name=__codelineno-20-13 href=#__codelineno-20-13></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>pow</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>);</span>
<a id=__codelineno-20-14 name=__codelineno-20-14 href=#__codelineno-20-14></a><span class=w>  </span><span class=p>});</span>
<a id=__codelineno-20-15 name=__codelineno-20-15 href=#__codelineno-20-15></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>task</span><span class=p>.</span><span class=n>get_future</span><span class=p>();</span>
<a id=__codelineno-20-16 name=__codelineno-20-16 href=#__codelineno-20-16></a>
<a id=__codelineno-20-17 name=__codelineno-20-17 href=#__codelineno-20-17></a><span class=w>  </span><span class=n>task</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>9</span><span class=p>);</span>
<a id=__codelineno-20-18 name=__codelineno-20-18 href=#__codelineno-20-18></a>
<a id=__codelineno-20-19 name=__codelineno-20-19 href=#__codelineno-20-19></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;task_lambda:</span><span class=se>\t</span><span class=s>&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=n>get</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
<a id=__codelineno-20-20 name=__codelineno-20-20 href=#__codelineno-20-20></a><span class=p>}</span>
<a id=__codelineno-20-21 name=__codelineno-20-21 href=#__codelineno-20-21></a>
<a id=__codelineno-20-22 name=__codelineno-20-22 href=#__codelineno-20-22></a><span class=kt>void</span><span class=w> </span><span class=nf>task_bind</span><span class=p>()</span>
<a id=__codelineno-20-23 name=__codelineno-20-23 href=#__codelineno-20-23></a><span class=p>{</span>
<a id=__codelineno-20-24 name=__codelineno-20-24 href=#__codelineno-20-24></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>packaged_task</span><span class=o>&lt;</span><span class=kt>int</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=n>task</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>bind</span><span class=p>(</span><span class=n>f</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>11</span><span class=p>));</span>
<a id=__codelineno-20-25 name=__codelineno-20-25 href=#__codelineno-20-25></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>task</span><span class=p>.</span><span class=n>get_future</span><span class=p>();</span>
<a id=__codelineno-20-26 name=__codelineno-20-26 href=#__codelineno-20-26></a>
<a id=__codelineno-20-27 name=__codelineno-20-27 href=#__codelineno-20-27></a><span class=w>  </span><span class=n>task</span><span class=p>();</span>
<a id=__codelineno-20-28 name=__codelineno-20-28 href=#__codelineno-20-28></a>
<a id=__codelineno-20-29 name=__codelineno-20-29 href=#__codelineno-20-29></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;task_bind:</span><span class=se>\t</span><span class=s>&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=n>get</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
<a id=__codelineno-20-30 name=__codelineno-20-30 href=#__codelineno-20-30></a><span class=p>}</span>
<a id=__codelineno-20-31 name=__codelineno-20-31 href=#__codelineno-20-31></a>
<a id=__codelineno-20-32 name=__codelineno-20-32 href=#__codelineno-20-32></a><span class=kt>void</span><span class=w> </span><span class=nf>task_thread</span><span class=p>()</span>
<a id=__codelineno-20-33 name=__codelineno-20-33 href=#__codelineno-20-33></a><span class=p>{</span>
<a id=__codelineno-20-34 name=__codelineno-20-34 href=#__codelineno-20-34></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>packaged_task</span><span class=o>&lt;</span><span class=kt>int</span><span class=p>(</span><span class=kt>int</span><span class=p>,</span><span class=kt>int</span><span class=p>)</span><span class=o>&gt;</span><span class=w> </span><span class=n>task</span><span class=p>(</span><span class=n>f</span><span class=p>);</span>
<a id=__codelineno-20-35 name=__codelineno-20-35 href=#__codelineno-20-35></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>task</span><span class=p>.</span><span class=n>get_future</span><span class=p>();</span>
<a id=__codelineno-20-36 name=__codelineno-20-36 href=#__codelineno-20-36></a>
<a id=__codelineno-20-37 name=__codelineno-20-37 href=#__codelineno-20-37></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>task_td</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>task</span><span class=p>),</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>10</span><span class=p>);</span>
<a id=__codelineno-20-38 name=__codelineno-20-38 href=#__codelineno-20-38></a><span class=w>  </span><span class=n>task_td</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
<a id=__codelineno-20-39 name=__codelineno-20-39 href=#__codelineno-20-39></a>
<a id=__codelineno-20-40 name=__codelineno-20-40 href=#__codelineno-20-40></a><span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;task_thread:</span><span class=se>\t</span><span class=s>&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=n>get</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
<a id=__codelineno-20-41 name=__codelineno-20-41 href=#__codelineno-20-41></a><span class=p>}</span>
<a id=__codelineno-20-42 name=__codelineno-20-42 href=#__codelineno-20-42></a>
<a id=__codelineno-20-43 name=__codelineno-20-43 href=#__codelineno-20-43></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
<a id=__codelineno-20-44 name=__codelineno-20-44 href=#__codelineno-20-44></a><span class=p>{</span>
<a id=__codelineno-20-45 name=__codelineno-20-45 href=#__codelineno-20-45></a><span class=w>  </span><span class=n>task_lambda</span><span class=p>();</span>
<a id=__codelineno-20-46 name=__codelineno-20-46 href=#__codelineno-20-46></a><span class=w>  </span><span class=n>task_bind</span><span class=p>();</span>
<a id=__codelineno-20-47 name=__codelineno-20-47 href=#__codelineno-20-47></a><span class=w>  </span><span class=n>task_thread</span><span class=p>();</span>
<a id=__codelineno-20-48 name=__codelineno-20-48 href=#__codelineno-20-48></a><span class=p>}</span>
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;cmath&gt;</span>
<a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
<a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;future&gt;</span>
<a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
<a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a>
<a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>std</span><span class=p>;</span>
<a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a>
<a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a><span class=k>static</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MAX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>10e8</span><span class=p>;</span>
<a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a>
<a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a><span class=kt>double</span><span class=w> </span><span class=nf>concurrent_worker</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>min</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>max</span><span class=p>)</span>
<a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a><span class=p>{</span>
<a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a><span class=w>  </span><span class=kt>double</span><span class=w> </span><span class=n>sum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>min</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>max</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a><span class=w>    </span><span class=n>sum</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>sqrt</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
<a id=__codelineno-21-16 name=__codelineno-21-16 href=#__codelineno-21-16></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-21-17 name=__codelineno-21-17 href=#__codelineno-21-17></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>sum</span><span class=p>;</span>
<a id=__codelineno-21-18 name=__codelineno-21-18 href=#__codelineno-21-18></a><span class=p>}</span>
<a id=__codelineno-21-19 name=__codelineno-21-19 href=#__codelineno-21-19></a>
<a id=__codelineno-21-20 name=__codelineno-21-20 href=#__codelineno-21-20></a><span class=kt>double</span><span class=w> </span><span class=nf>concurrent_task</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>min</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>max</span><span class=p>)</span>
<a id=__codelineno-21-21 name=__codelineno-21-21 href=#__codelineno-21-21></a><span class=p>{</span>
<a id=__codelineno-21-22 name=__codelineno-21-22 href=#__codelineno-21-22></a><span class=w>  </span><span class=n>vector</span><span class=o>&lt;</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>double</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>results</span><span class=p>;</span><span class=w>  </span><span class=c1>// future list to store results</span>
<a id=__codelineno-21-23 name=__codelineno-21-23 href=#__codelineno-21-23></a>
<a id=__codelineno-21-24 name=__codelineno-21-24 href=#__codelineno-21-24></a><span class=w>  </span><span class=kt>unsigned</span><span class=w> </span><span class=n>concurrent_count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>thread</span><span class=o>::</span><span class=n>hardware_concurrency</span><span class=p>();</span>
<a id=__codelineno-21-25 name=__codelineno-21-25 href=#__codelineno-21-25></a><span class=w>  </span><span class=n>min</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-21-26 name=__codelineno-21-26 href=#__codelineno-21-26></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>concurrent_count</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-21-27 name=__codelineno-21-27 href=#__codelineno-21-27></a><span class=w>    </span><span class=n>packaged_task</span><span class=o>&lt;</span><span class=kt>double</span><span class=p>(</span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=o>&gt;</span><span class=w> </span><span class=n>task</span><span class=p>(</span><span class=n>concurrent_worker</span><span class=p>);</span><span class=w>  </span><span class=c1>// package task</span>
<a id=__codelineno-21-28 name=__codelineno-21-28 href=#__codelineno-21-28></a><span class=w>    </span><span class=n>results</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>task</span><span class=p>.</span><span class=n>get_future</span><span class=p>());</span><span class=w>                     </span><span class=c1>// store associated future objects</span>
<a id=__codelineno-21-29 name=__codelineno-21-29 href=#__codelineno-21-29></a>
<a id=__codelineno-21-30 name=__codelineno-21-30 href=#__codelineno-21-30></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>range</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>max</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>concurrent_count</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
<a id=__codelineno-21-31 name=__codelineno-21-31 href=#__codelineno-21-31></a><span class=w>    </span><span class=kr>thread</span><span class=w> </span><span class=n>t</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>task</span><span class=p>),</span><span class=w> </span><span class=n>min</span><span class=p>,</span><span class=w> </span><span class=n>range</span><span class=p>);</span><span class=w>  </span><span class=c1>// launch new thread</span>
<a id=__codelineno-21-32 name=__codelineno-21-32 href=#__codelineno-21-32></a><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=n>detach</span><span class=p>();</span>
<a id=__codelineno-21-33 name=__codelineno-21-33 href=#__codelineno-21-33></a>
<a id=__codelineno-21-34 name=__codelineno-21-34 href=#__codelineno-21-34></a><span class=w>    </span><span class=n>min</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>range</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-21-35 name=__codelineno-21-35 href=#__codelineno-21-35></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-21-36 name=__codelineno-21-36 href=#__codelineno-21-36></a>
<a id=__codelineno-21-37 name=__codelineno-21-37 href=#__codelineno-21-37></a><span class=w>  </span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;threads create finish&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-21-38 name=__codelineno-21-38 href=#__codelineno-21-38></a><span class=w>  </span><span class=kt>double</span><span class=w> </span><span class=n>sum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-21-39 name=__codelineno-21-39 href=#__codelineno-21-39></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=o>&amp;</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>results</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-21-40 name=__codelineno-21-40 href=#__codelineno-21-40></a><span class=w>    </span><span class=n>sum</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=n>get</span><span class=p>();</span><span class=w>  </span><span class=c1>// add results up</span>
<a id=__codelineno-21-41 name=__codelineno-21-41 href=#__codelineno-21-41></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-21-42 name=__codelineno-21-42 href=#__codelineno-21-42></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>sum</span><span class=p>;</span>
<a id=__codelineno-21-43 name=__codelineno-21-43 href=#__codelineno-21-43></a><span class=p>}</span>
<a id=__codelineno-21-44 name=__codelineno-21-44 href=#__codelineno-21-44></a>
<a id=__codelineno-21-45 name=__codelineno-21-45 href=#__codelineno-21-45></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
<a id=__codelineno-21-46 name=__codelineno-21-46 href=#__codelineno-21-46></a><span class=p>{</span>
<a id=__codelineno-21-47 name=__codelineno-21-47 href=#__codelineno-21-47></a><span class=w>  </span><span class=k>auto</span><span class=w> </span><span class=n>start_time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>chrono</span><span class=o>::</span><span class=n>steady_clock</span><span class=o>::</span><span class=n>now</span><span class=p>();</span>
<a id=__codelineno-21-48 name=__codelineno-21-48 href=#__codelineno-21-48></a><span class=w>  </span><span class=kt>double</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>concurrent_task</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>MAX</span><span class=p>);</span>
<a id=__codelineno-21-49 name=__codelineno-21-49 href=#__codelineno-21-49></a><span class=w>  </span><span class=k>auto</span><span class=w> </span><span class=n>end_time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>chrono</span><span class=o>::</span><span class=n>steady_clock</span><span class=o>::</span><span class=n>now</span><span class=p>();</span>
<a id=__codelineno-21-50 name=__codelineno-21-50 href=#__codelineno-21-50></a><span class=w>  </span><span class=k>auto</span><span class=w> </span><span class=n>ms</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>chrono</span><span class=o>::</span><span class=n>duration_cast</span><span class=o>&lt;</span><span class=n>chrono</span><span class=o>::</span><span class=n>milliseconds</span><span class=o>&gt;</span><span class=p>(</span><span class=n>end_time</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start_time</span><span class=p>).</span><span class=n>count</span><span class=p>();</span>
<a id=__codelineno-21-51 name=__codelineno-21-51 href=#__codelineno-21-51></a><span class=w>  </span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Concurrent task finish, &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>ms</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; ms consumed, Result: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-21-52 name=__codelineno-21-52 href=#__codelineno-21-52></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-21-53 name=__codelineno-21-53 href=#__codelineno-21-53></a><span class=p>}</span>
</code></pre></div> <p>In real projects, you can package tasks into queues with the help of <code>packaged_task</code> and then schedule them by means of thread pools.</p> <p><a class=glightbox href=https://paul-pub.oss-cn-beijing.aliyuncs.com/2019/2019-11-26-cpp-concurrency/Thread_pool.svg data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt="task queue" src=https://paul-pub.oss-cn-beijing.aliyuncs.com/2019/2019-11-26-cpp-concurrency/Thread_pool.svg></a></p> <p>A <code>packaged_task</code> won't start on it's own, you have to invoke it. On the other hand, <code>std::async</code> with <code>launch::async</code> will try to run the task in a different thread. By using <code>std::async</code> you cannot run your task on a specific thread anymore, where <code>std::packaged_task</code> can be moved to other threads.</p> <p>In the end a <code>std::packaged_task</code> is just a lower level feature for implementing <code>std::async</code> (which is why it can do more than <code>std::async</code> if used together with other lower level stuff, like <code>std::thread</code>). Simply spoken a <code>std::packaged_task</code> is a <code>std::function</code> linked to a <code>std::future</code> and <code>std::async</code> wraps and calls a <code>std::packaged_task</code> (possibly in a different thread).</p> <div class="admonition tldr"> <p class=admonition-title>Tldr</p> <p>Use <code>std::async</code> if you want some things done and don't really care when they're done, and <code>std::packaged_task</code> if you want to wrap up things in order to move them to other threads or call them later.</p> </div> <h2 id=parallel-stl>Parallel STL<a class=headerlink href=#parallel-stl title="Permanent link">&para;</a></h2> <p>With C++17, most of the algorithms of the Standard Template Library will be available in a parallel version. Therefore, you can invoke an algorithm with a so-called execution policy. This execution policy specifies if the algorithm runs sequential (<code>std::seq</code>), parallel (<code>std::par</code>), or parallel and vectorised (<code>std::par_unseq</code>).</p> <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>vec</span><span class=w> </span><span class=o>=</span><span class=p>{</span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>,</span><span class=w> </span><span class=mi>6</span><span class=p>,</span><span class=w> </span><span class=mi>10</span><span class=p>,</span><span class=w> </span><span class=mi>8</span><span class=p>,</span><span class=w> </span><span class=mi>9</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>};</span>
<a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a>
<a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=n>std</span><span class=o>::</span><span class=n>sort</span><span class=p>(</span><span class=n>vec</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>vec</span><span class=p>.</span><span class=n>end</span><span class=p>());</span><span class=w>                            </span><span class=c1>// sequential as ever</span>
<a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=n>std</span><span class=o>::</span><span class=n>sort</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>execution</span><span class=o>::</span><span class=n>seq</span><span class=p>,</span><span class=w> </span><span class=n>vec</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>vec</span><span class=p>.</span><span class=n>end</span><span class=p>());</span><span class=w>       </span><span class=c1>// sequential</span>
<a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=n>std</span><span class=o>::</span><span class=n>sort</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>execution</span><span class=o>::</span><span class=n>par</span><span class=p>,</span><span class=w> </span><span class=n>vec</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>vec</span><span class=p>.</span><span class=n>end</span><span class=p>());</span><span class=w>       </span><span class=c1>// parallel</span>
<a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a><span class=n>std</span><span class=o>::</span><span class=n>sort</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>execution</span><span class=o>::</span><span class=n>par_unseq</span><span class=p>,</span><span class=w> </span><span class=n>vec</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>vec</span><span class=p>.</span><span class=n>end</span><span class=p>());</span><span class=w> </span><span class=c1>// parallel and vectorized</span>
</code></pre></div> <p>Therefore, the first and second variations of the sort algorithm run sequential, the third parallel, and the fourth parallel and vectorised.</p> <p>C++20 offers totally new multithreading concepts. The key idea is that multithreading becomes a lot simpler and less error-prone.</p> <div class=footnote> <hr> <ol> <li id=fn:1> <p>https://en.wikipedia.org/wiki/Therac-25&#160;<a class=footnote-backref href=#fnref:1 title="Jump back to footnote 1 in the text">&#8617;</a></p> </li> </ol> </div> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="January 17, 2023 23:01:07">January 17, 2023</span> </span> </aside> <h2 id=__comments>Comments</h2> <script src=https://giscus.app/client.js data-repo=leonhartyao/leonhartyao.github.io data-repo-id=R_kgDOIuPBcQ data-category=General data-category-id=DIC_kwDOIuPBcc4CTdUo data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=en crossorigin=anonymous async>
</script> <!-- Synchronize Giscus theme with palette --> <script>
var giscus = document.querySelector("script[src*=giscus]")

/* Set palette on initial load */
var palette = __md_get("__palette")
if (palette && typeof palette.color === "object") {
    var theme = palette.color.scheme === "slate" ? "dark" : "light"
    giscus.setAttribute("data-theme", theme)
}

/* Register event handlers after documented loaded */
document.addEventListener("DOMContentLoaded", function() {
    var ref = document.querySelector("[data-md-component=palette]")
    ref.addEventListener("change", function() {
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
        var theme = palette.color.scheme === "slate" ? "dark" : "light"

        /* Instruct Giscus to change theme */
        var frame = document.querySelector(".giscus-frame")
        frame.contentWindow.postMessage(
        { giscus: { setConfig: { theme } } },
        "https://giscus.app"
        )
    }
    })
})
</script> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2023 Chao Yao </div> </div> <div class=md-social> <a href=https://www.linkedin.com/in/dr-ing-chao-y-88032bba/ target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href=https://github.com/leonhartyao target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://gitlab.com/chaolmu target=_blank rel=noopener title=gitlab.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="m503.5 204.6-.7-1.8-69.7-181.78c-1.4-3.57-3.9-6.59-7.2-8.64-2.4-1.55-5.1-2.515-8-2.81s-5.7.083-8.4 1.11c-2.7 1.02-5.1 2.66-7.1 4.78-1.9 2.12-3.3 4.67-4.1 7.44l-47 144H160.8l-47.1-144c-.8-2.77-2.2-5.31-4.1-7.43-2-2.12-4.4-3.75-7.1-4.77a18.1 18.1 0 0 0-8.38-1.113 18.4 18.4 0 0 0-8.04 2.793 18.1 18.1 0 0 0-7.16 8.64L9.267 202.8l-.724 1.8a129.57 129.57 0 0 0-3.52 82c7.747 26.9 24.047 50.7 46.447 67.6l.27.2.59.4 105.97 79.5 52.6 39.7 32 24.2c3.7 1.9 8.3 4.3 13 4.3s9.3-2.4 13-4.3l32-24.2 52.6-39.7 106.7-79.9.3-.3c22.4-16.9 38.7-40.6 45.6-67.5 8.6-27 7.4-55.8-2.6-82"/></svg> </a> <a href=https://orcid.org/0000-0001-8599-112X target=_blank rel=noopener title=orcid.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M294.75 188.19h-45.92V342h47.47c67.62 0 83.12-51.34 83.12-76.91 0-41.64-26.54-76.9-84.67-76.9M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8m-80.79 360.76h-29.84v-207.5h29.84zm-14.92-231.14a19.57 19.57 0 1 1 19.57-19.57 19.64 19.64 0 0 1-19.57 19.57M300 369h-81V161.26h80.6c76.73 0 110.44 54.83 110.44 103.85C410 318.39 368.38 369 300 369"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["content.action.edit", "content.code.annotate", "content.code.copy", "content.tabs.link", "content.tooltips", "navigation.indexes", "navigation.sections", "navigation.top", "navigation.footer", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.13a4f30d.min.js></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>